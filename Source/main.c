//NAME: 	"main.c"
//AUTHOR:	M.KRUK
//DATE 	:	XI.2017

#include "init.h"
#include "arm_math.h"
#include "arm_const_structs.h"

// >>>>>>>>> VARIABLES
volatile uint8_t afe_rdc_rdy_flag;

extern float srednia;
extern int32_t srednia2;

// ========== FIR =====================
#define N 396

uint32_t x[N];

const float32_t h[N] = {

		  -8.272102423e-05,-0.0001782764011,-0.0003203887318,-0.0004744969483,-0.0005918182433,
		  -0.0006091914838,-0.0004642918357,-0.000116521478,0.0004338247527, 0.001133780694,
		   0.001880242955, 0.002538627479, 0.002974238014,  0.00308906287, 0.002852465026,
		   0.002315359423,   0.0016019576,0.0008793047746,0.0003126615484,1.981485912e-05,
		   3.87512373e-05,0.0003190570278,0.0007402213523,  0.00115130865, 0.001418928732,
		   0.001467721886, 0.001300382544,0.0009910569061,0.0006553398562, 0.000408032618,
		  0.0003239695507,0.0004153160844,0.0006324141868,0.0008864699048, 0.001084513031,
		   0.001163037145, 0.001108081546,0.0009552348056,0.0007712620427,0.0006258077919,
		  0.0005649384111,0.0005965389428,0.0006922559114,0.0008035417413,0.0008838061476,
		  0.0009068320505,0.0008741922211,0.0008096474339,0.0007445343654,0.0007017556345,
		  0.0006861469592, 0.000685260864,0.0006793862558,0.0006549134268, 0.000613642449,
		  0.0005727336975,0.0005550150527, 0.000574450416,0.0006246740813, 0.000677416625,
		  0.0006932118558,0.0006404085434,0.0005137822591,0.0003429328499,0.0001846060622,
		   0.000100214369,0.0001273780654,0.0002582434099,0.0004359373706,0.0005732726422,
		  0.0005880490062,0.0004407475353,0.0001577715302,-0.0001721102017,-0.0004295859253,
		  -0.0005138781271,-0.000389018358,-0.0001065534016,0.0002078573161,0.0004015941231,
		  0.0003586540697,5.332856745e-05,-0.000430287997,-0.0009246341069,-0.001243428793,
		  -0.001260148594,-0.0009673688328,-0.0004898056504,-4.157247531e-05,0.0001583281701,
		  -2.072568714e-05,-0.0005584239843,-0.001280801604,-0.001923068194,-0.002235837514,
		  -0.002092490206, -0.00155175745,-0.0008456822834,-0.0002928333706,-0.0001687494223,
		  -0.0005859071389,-0.001435110462,-0.002417282667,   -0.003158123,-0.003362111282,
		  -0.002942914842,-0.002073162468, -0.00112741068,-0.0005357952323,-0.0006051030359,
		  -0.001381200389,-0.002613835735,-0.003844869323,-0.004589966033,-0.004542152863,
		  -0.003712250618, -0.00244284817, -0.00128255866,-0.0007656756788,-0.001185207046,
		   -0.00245500938,-0.004124602769,-0.005549030378,-0.006150702946,-0.005667509511,
		  -0.004281442147, -0.00256652222, -0.00126798579,-0.0009966652142,-0.001963188872,
		  -0.003866584506,-0.005993051454,-0.007494741585,-0.007740741596,-0.006595816929,
		   -0.00450514676,-0.002338427817,-0.001045924728,-0.001261285855,-0.003016014583,
		  -0.005692366976,-0.008247945458,-0.009632277302,-0.009230324067,-0.007147116121,
		  -0.004204445984,-0.001634625252,-0.0005833253963,-0.001620306517,-0.004464976955,
		  -0.008054958656, -0.01094880141, -0.01191258803, -0.01045400929,-0.007075554691,
		  -0.003123214003,-0.0002698293247,0.0001715958933,  -0.0021740722,-0.006525066681,
		    -0.0111976834, -0.01425845455, -0.01432489883,  -0.0111878328,-0.005981451366,
		  -0.0007988575962, 0.002123907208, 0.001343009062,-0.003122854512,-0.009687678888,
		   -0.01574517228, -0.01868828945, -0.01701144129, -0.01104113087,-0.002959249774,
		   0.003950228449, 0.006584752351, 0.003350537037,-0.005012752023, -0.01549869869,
		    -0.0238516368, -0.02621265128, -0.02078618109,-0.008851478808, 0.005362508819,
		    0.01601880789,  0.01784195937, 0.008366530761, -0.01058960985, -0.03287285939,
		   -0.04954094812, -0.05161879957, -0.03320365027, 0.006131463218,  0.06051623449,
		     0.1189344227,   0.1680896282,   0.1961402148,   0.1961402148,   0.1680896282,
		     0.1189344227,  0.06051623449, 0.006131463218, -0.03320365027, -0.05161879957,
		   -0.04954094812, -0.03287285939, -0.01058960985, 0.008366530761,  0.01784195937,
		    0.01601880789, 0.005362508819,-0.008851478808, -0.02078618109, -0.02621265128,
		    -0.0238516368, -0.01549869869,-0.005012752023, 0.003350537037, 0.006584752351,
		   0.003950228449,-0.002959249774, -0.01104113087, -0.01701144129, -0.01868828945,
		   -0.01574517228,-0.009687678888,-0.003122854512, 0.001343009062, 0.002123907208,
		  -0.0007988575962,-0.005981451366,  -0.0111878328, -0.01432489883, -0.01425845455,
		    -0.0111976834,-0.006525066681,  -0.0021740722,0.0001715958933,-0.0002698293247,
		  -0.003123214003,-0.007075554691, -0.01045400929, -0.01191258803, -0.01094880141,
		  -0.008054958656,-0.004464976955,-0.001620306517,-0.0005833253963,-0.001634625252,
		  -0.004204445984,-0.007147116121,-0.009230324067,-0.009632277302,-0.008247945458,
		  -0.005692366976,-0.003016014583,-0.001261285855,-0.001045924728,-0.002338427817,
		   -0.00450514676,-0.006595816929,-0.007740741596,-0.007494741585,-0.005993051454,
		  -0.003866584506,-0.001963188872,-0.0009966652142, -0.00126798579, -0.00256652222,
		  -0.004281442147,-0.005667509511,-0.006150702946,-0.005549030378,-0.004124602769,
		   -0.00245500938,-0.001185207046,-0.0007656756788, -0.00128255866, -0.00244284817,
		  -0.003712250618,-0.004542152863,-0.004589966033,-0.003844869323,-0.002613835735,
		  -0.001381200389,-0.0006051030359,-0.0005357952323, -0.00112741068,-0.002073162468,
		  -0.002942914842,-0.003362111282,   -0.003158123,-0.002417282667,-0.001435110462,
		  -0.0005859071389,-0.0001687494223,-0.0002928333706,-0.0008456822834, -0.00155175745,
		  -0.002092490206,-0.002235837514,-0.001923068194,-0.001280801604,-0.0005584239843,
		  -2.072568714e-05,0.0001583281701,-4.157247531e-05,-0.0004898056504,-0.0009673688328,
		  -0.001260148594,-0.001243428793,-0.0009246341069,-0.000430287997,5.332856745e-05,
		  0.0003586540697,0.0004015941231,0.0002078573161,-0.0001065534016,-0.000389018358,
		  -0.0005138781271,-0.0004295859253,-0.0001721102017,0.0001577715302,0.0004407475353,
		  0.0005880490062,0.0005732726422,0.0004359373706,0.0002582434099,0.0001273780654,
		   0.000100214369,0.0001846060622,0.0003429328499,0.0005137822591,0.0006404085434,
		  0.0006932118558, 0.000677416625,0.0006246740813, 0.000574450416,0.0005550150527,
		  0.0005727336975, 0.000613642449,0.0006549134268,0.0006793862558, 0.000685260864,
		  0.0006861469592,0.0007017556345,0.0007445343654,0.0008096474339,0.0008741922211,
		  0.0009068320505,0.0008838061476,0.0008035417413,0.0006922559114,0.0005965389428,
		  0.0005649384111,0.0006258077919,0.0007712620427,0.0009552348056, 0.001108081546,
		   0.001163037145, 0.001084513031,0.0008864699048,0.0006324141868,0.0004153160844,
		  0.0003239695507, 0.000408032618,0.0006553398562,0.0009910569061, 0.001300382544,
		   0.001467721886, 0.001418928732,  0.00115130865,0.0007402213523,0.0003190570278,
		   3.87512373e-05,1.981485912e-05,0.0003126615484,0.0008793047746,   0.0016019576,
		   0.002315359423, 0.002852465026,  0.00308906287, 0.002974238014, 0.002538627479,
		   0.001880242955, 0.001133780694,0.0004338247527,-0.000116521478,-0.0004642918357,
		  -0.0006091914838,-0.0005918182433,-0.0004744969483,-0.0003203887318,-0.0001782764011,
		  -8.272102423e-05
};

// FFT varaibles
#define IN_BUF_SIZE ((uint16_t)512)
arm_rfft_fast_instance_f32 S;
float32_t buffer_input[IN_BUF_SIZE];
float32_t buffer_output[IN_BUF_SIZE*2];
float32_t buffer_output_mag[IN_BUF_SIZE*2];
uint32_t fft_cnt = 0;

const float hrFac	= 11.71875;		//hrFac = fs/fftsize * 60 = 11.71875
float HR = 0; 

// >>>>>>>>> MAIN
int main(void){

	// Buffor for printing service logs
	char print[100];
	
	// Variables for FFT
	float32_t maxvalue;
	uint32_t  maxvalueindex;
	
	// Variables for AFR led current read
	int8_t sign = 2;
	uint8_t range;
	
	// Variables for FIR
	uint16_t i;
	float32_t y = 0;

	
	// Value of current form leds
	int32_t led1Val,led2Val;	
	
	//bInit functions
	HAL_Init();
	init();
	
	// FFT init
	arm_rfft_fast_init_f32(&S, 512);
	
	//Reset buffer_input
	for(i = 0 ; i < IN_BUF_SIZE ; i++) buffer_input[i] = 0;
	
	while(1)
	{
		//If AFE adc is ready
		if(afe_rdc_rdy_flag){
			
			//reset flag
			afe_rdc_rdy_flag = 0x00;
			
			//LL_GPIO_SetOutputPin(TIM_MEAS_PORT, TIM_MEAS_PIN);                  // TIME MEASURMENT START
			
			led1Val = afeReadLedCur(1 , &sign , &range);		// Read LED 1 ADC value
			led2Val = afeReadLedCur(2 , &sign , &range);		// Read LED 2 ADC value
			
			//LL_GPIO_ResetOutputPin(TIM_MEAS_PORT, TIM_MEAS_PIN);                 // TIME MEASURMENT STOP, RESULT 1,8 [ms]

			// ========== FIR ============={
			
			//LL_GPIO_SetOutputPin(TIM_MEAS_PORT, TIM_MEAS_PIN);                  // TIME MEASURMENT START
			
			y = 0;

			for(i = 0; i < N; i++) y = y + x[i]*h[N-i];

			for(i = 0; i < (N-1); i++) x[i] = x[i+1];

			x[N-1] = led1Val;
			
			//LL_GPIO_ResetOutputPin(TIM_MEAS_PORT, TIM_MEAS_PIN);                 // TIME MEASURMENT STOP, RESULT 415 [us]

			// }========== FIR END =============
			
			buffer_input[fft_cnt] = y;

			fft_cnt++; 
			if(IN_BUF_SIZE == fft_cnt){
				fft_cnt = 0;
					
				// Calculate Real FFT
				arm_rfft_fast_f32(&S, buffer_input, buffer_output , 0);								// TIME: 1 ms
						
				// Calculate magnitude
				arm_cmplx_mag_f32(buffer_output, buffer_output_mag, IN_BUF_SIZE);							// TIME: 385 us
				
				// Get maximum value of magnitude
				arm_max_f32(buffer_output_mag, IN_BUF_SIZE, &maxvalue, &maxvalueindex);				// TIME: 95 us
					
				HR = maxvalueindex*hrFac;
				
				//sprintf(print , "%f\r\n" ,HR);
				//serviceUartWriteS(print);
				
				for(i=0 ; i < (IN_BUF_SIZE/2) ; i++){
					sprintf(print , "%f\r\n" ,buffer_output_mag[i]);
					serviceUartWriteS(print);
				}
			}
		}
	}
	
}

